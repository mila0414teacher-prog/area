<!doctype html>
<html lang="zh-TW" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç¨®èŠ±é«˜æ‰‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; }
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
    .flower-icon{ animation: float 3s ease-in-out infinite; }
    #gameCanvas{ border: 3px solid; }
  </style>
</head>

<body class="h-full overflow-auto">
  <div id="app" class="w-full h-full"></div>

  <script>
    // =====================
    // âœ… localStorage (ç´€éŒ„)
    // =====================
    const STORAGE_KEY = "flower_game_records_v3";
    function loadRecords() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
      catch { return []; }
    }
    function saveRecord(record) {
      const records = loadRecords();
      records.push(record);
      records.sort((a,b)=>b.timestamp-a.timestamp);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(records.slice(0, 999)));
      return records.slice(0, 999);
    }

    // =====================
    // âœ… UI è¨­å®š
    // =====================
    const config = {
      background_color: "#FFF8DC",
      surface_color: "#FFFFFF",
      text_color: "#2C5530",
      primary_action_color: "#4CAF50",
      secondary_action_color: "#FF9800",
      font_family: "sans-serif",
      font_size: 16,
      game_title: "ğŸŒ¸ ç¨®èŠ±é«˜æ‰‹ ğŸŒ¸",
      start_button_text: "é–‹å§‹éŠæˆ²",
      records_button_text: "éŠæˆ²ç´€éŒ„"
    };

    let currentScreen = "home";
    let currentQuestion = null;
    let score = 0;
    let questionsAnswered = 0;

    let gameInterval = null;
    let runnerY = 150;
    let runnerX = 50;
    let flowers = [];

    // =====================
    // âœ… å·¥å…·ï¼šéš¨æ©Ÿ/æ ¼å¼
    // =====================
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function shuffle(arr){
      const a = [...arr];
      for (let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }
    function uniqueNumbers(arr){
      return [...new Set(arr)];
    }
    function unitSq(unit){ return unit + "Â²"; }

    // =====================
    // âœ… è‡ªå‹•ç”¢ç”Ÿé¸é …ï¼ˆ1æ­£ç¢º + 3å¹²æ“¾ï¼‰
    // æ¯å€‹é¸é …ä¸€è¡Œå¯«å®Œç®—å¼
    // =====================
    function buildOptions({ type, base, height, unit, a, b }) {
      // å›å‚³ { options: [string...], correctIndex }
      // type: "parallelogram" | "triangle" | "rightTriangle"
      // parallelogram: base,height
      // triangle: base,height
      // rightTriangle: a,b (å…©ç›´è§’é‚Š) => base=b height=a (æ¦‚å¿µä¸Š)

      let correctValue = 0;
      let correctExpr = "";

      if (type === "parallelogram") {
        correctValue = base * height;
        correctExpr = `${base} Ã— ${height} = ${correctValue} ${unitSq(unit)}`;
      } else if (type === "triangle") {
        correctValue = (base * height) / 2;
        correctExpr = `${base} Ã— ${height} Ã· 2 = ${correctValue} ${unitSq(unit)}`;
      } else if (type === "rightTriangle") {
        correctValue = (a * b) / 2;
        correctExpr = `${a} Ã— ${b} Ã· 2 = ${correctValue} ${unitSq(unit)}`;
      } else {
        correctValue = base * height;
        correctExpr = `${base} Ã— ${height} = ${correctValue} ${unitSq(unit)}`;
      }

      // å¹²æ“¾å€¼ï¼ˆå¸¸è¦‹éŒ¯èª¤ï¼‰
      const wrongValues = [];
      if (type === "parallelogram") {
        wrongValues.push((base * height) / 2);      // å¤šé™¤2
        wrongValues.push(base + height);            // åŠ æ³•
        wrongValues.push((base + height) * height); // äº‚ç”¨ï¼ˆä¸Šåº•+ä¸‹åº•ï¼‰Ã—é«˜
      } else if (type === "triangle" || type === "rightTriangle") {
        // å¿˜è¨˜ Ã·2
        const prod = (type === "rightTriangle") ? (a*b) : (base*height);
        wrongValues.push(prod);
        wrongValues.push(base + height);                // åŠ æ³•ï¼ˆæˆ– a+bï¼‰
        wrongValues.push(((base + height) * height) / 2); // äº‚ç”¨æ¢¯å½¢
        if (type === "rightTriangle") {
          wrongValues[1] = a + b;
          wrongValues[2] = ((a + b) * b) / 2;
        }
      }

      // å†è£œä¸€äº›å¾®èª¿å¹²æ“¾ï¼Œç¢ºä¿å¤ ç”¨ä¸”ä¸åŒ
      wrongValues.push(correctValue + randInt(1, 6) * 2);
      wrongValues.push(Math.max(1, correctValue - randInt(1, 6) * 2));

      // å»é‡ã€å»æ‰æ­£ç¢º
      const cleanedWrong = uniqueNumbers(
        wrongValues
          .map(v => (Number.isFinite(v) ? Math.round(v*100)/100 : v))
          .filter(v => v !== correctValue && v > 0)
      );

      // å–å‰ä¸‰å€‹å¹²æ“¾
      const chosenWrong = cleanedWrong.slice(0, 3);

      // è‹¥ä¸è¶³ä¸‰å€‹ï¼Œå†è£œä¸€äº›ã€Œçœ‹èµ·ä¾†åˆç†ã€çš„æ•¸
      while (chosenWrong.length < 3) {
        const v = correctValue + randInt(2, 20);
        if (v !== correctValue && !chosenWrong.includes(v)) chosenWrong.push(v);
      }

      // æŠŠå¹²æ“¾å€¼è½‰æˆä¸€è¡Œç®—å¼ï¼ˆä¿æŒåŒä¸€ç¨®æ ¼å¼ï¼‰
      const wrongExprs = chosenWrong.map(v => {
        if (type === "parallelogram") {
          // å¸¸è¦‹å¹²æ“¾å½¢å¼æ··æ­
          const forms = [
            `${base} Ã— ${height} Ã· 2 = ${v} ${unitSq(unit)}`,
            `${base} + ${height} = ${v} ${unitSq(unit)}`,
            `(${base} + ${height}) Ã— ${height} = ${v} ${unitSq(unit)}`
          ];
          return forms[chosenWrong.indexOf(v) % forms.length];
        }
        if (type === "triangle") {
          const forms = [
            `${base} Ã— ${height} = ${v} ${unitSq(unit)}`,
            `${base} + ${height} = ${v} ${unitSq(unit)}`,
            `(${base} + ${height}) Ã— ${height} Ã· 2 = ${v} ${unitSq(unit)}`
          ];
          return forms[chosenWrong.indexOf(v) % forms.length];
        }
        // rightTriangle
        const forms = [
          `${a} Ã— ${b} = ${v} ${unitSq(unit)}`,
          `${a} + ${b} = ${v} ${unitSq(unit)}`,
          `(${a} + ${b}) Ã— ${b} Ã· 2 = ${v} ${unitSq(unit)}`
        ];
        return forms[chosenWrong.indexOf(v) % forms.length];
      });

      // åˆä½µå¾Œæ´—ç‰Œï¼Œæ‰¾æ­£ç¢ºä½ç½®
      const all = shuffle([correctExpr, ...wrongExprs]);
      return { options: all, correctIndex: all.indexOf(correctExpr) };
    }

    // =====================
    // âœ… å‡ºé¡Œå™¨ï¼šéš¨æ©Ÿåº•é«˜ã€éš¨æ©Ÿé¡Œå‹
    // - ä¸‰è§’å½¢ç¢ºä¿ base*height æ˜¯å¶æ•¸ï¼Œé¢ç©æ•´æ•¸
    // =====================
    function generateQuestion() {
      const pool = ["paraA", "paraB", "triA", "triB", "rightTri"];
      const shape = pool[randInt(0, pool.length - 1)];

      // å–®ä½ï¼šcm / mï¼ˆå¯ä¾ä½ éœ€æ±‚å›ºå®šï¼‰
      const unit = (shape === "paraB") ? "m" : "cm";

      if (shape === "paraA") {
        const base = randInt(6, 18);
        const height = randInt(4, 14);
        const { options, correctIndex } = buildOptions({ type:"parallelogram", base, height, unit });
        return {
          shape,
          text: "å¹³è¡Œå››é‚Šå½¢ï¼ˆå¦‚åœ–ï¼‰ï¼šæ±‚é¢ç©",
          dimensions: { base, height, unit },
          options,
          correct: correctIndex
        };
      }

      if (shape === "paraB") {
        const base = randInt(6, 20);
        const height = randInt(10, 30);
        const { options, correctIndex } = buildOptions({ type:"parallelogram", base, height, unit });
        return {
          shape,
          text: "å¹³è¡Œå››é‚Šå½¢ï¼ˆå¦‚åœ–ï¼‰ï¼šæ±‚é¢ç©",
          dimensions: { base, height, unit },
          options,
          correct: correctIndex
        };
      }

      if (shape === "triA") {
        let base = randInt(6, 20);
        let height = randInt(4, 18);
        // ç¢ºä¿ base*height å¶æ•¸
        if ((base * height) % 2 !== 0) base += 1;
        const { options, correctIndex } = buildOptions({ type:"triangle", base, height, unit });
        return {
          shape,
          text: "ä¸‰è§’å½¢ï¼ˆå¦‚åœ–ï¼‰ï¼šæ±‚é¢ç©",
          dimensions: { base, height, unit },
          options,
          correct: correctIndex
        };
      }

      if (shape === "triB") {
        let base = randInt(6, 16);
        let height = randInt(4, 14);
        if ((base * height) % 2 !== 0) height += 1;
        const side = randInt(7, 18); // åªæ˜¯è£é£¾ç”¨ï¼ˆåƒç¯„ä¾‹ 8cmï¼‰
        const { options, correctIndex } = buildOptions({ type:"triangle", base, height, unit });
        return {
          shape,
          text: "ä¸‰è§’å½¢ï¼ˆå¦‚åœ–ï¼‰ï¼šæ±‚é¢ç©",
          dimensions: { base, height, side, unit },
          options,
          correct: correctIndex
        };
      }

      // rightTri
      let a = randInt(6, 20);
      let b = randInt(4, 16);
      if ((a * b) % 2 !== 0) a += 1;
      const c = Math.round(Math.sqrt(a*a + b*b)); // è£é£¾é¡¯ç¤ºï¼ˆä¸å¼·æ±‚ç•¢æ°æ•´æ•¸ï¼‰
      const { options, correctIndex } = buildOptions({ type:"rightTriangle", a, b, unit, base:b, height:a });
      return {
        shape,
        text: "ç›´è§’ä¸‰è§’å½¢ï¼ˆå¦‚åœ–ï¼‰ï¼šæ±‚é¢ç©",
        dimensions: { a, b, c, unit },
        options,
        correct: correctIndex
      };
    }

    // =====================
    // âœ… UI render
    // =====================
    function render() {
      const app = document.getElementById("app");
      const baseSize = config.font_size;
      const bgColor = config.background_color;
      const surfaceColor = config.surface_color;
      const textColor = config.text_color;
      const primaryColor = config.primary_action_color;
      const secondaryColor = config.secondary_action_color;

      app.style.backgroundColor = bgColor;
      app.style.fontFamily = `${config.font_family}, Arial, sans-serif`;
      app.style.color = textColor;

      if (currentScreen === "home") {
        app.innerHTML = `
          <div class="flex flex-col items-center justify-center h-full px-4 py-10">
            <h1 class="font-bold mb-8 text-center" style="font-size:${baseSize*2.5}px;color:${textColor};">
              ${config.game_title}
            </h1>
            <div class="flower-icon mb-12 text-8xl">ğŸŒºğŸŒ»ğŸŒ·</div>

            <button id="startBtn"
              class="px-8 py-4 rounded-lg font-bold shadow-lg hover:opacity-90 transition mb-4"
              style="background:${primaryColor};color:#fff;font-size:${baseSize*1.2}px;">
              ${config.start_button_text}
            </button>

            <button id="recordsBtn"
              class="px-6 py-3 rounded-lg font-bold shadow-lg hover:opacity-90 transition"
              style="background:${secondaryColor};color:#fff;font-size:${baseSize}px;">
              ${config.records_button_text}
            </button>
          </div>
        `;
        document.getElementById("startBtn").onclick = startGame;
        document.getElementById("recordsBtn").onclick = showRecords;
        return;
      }

      if (currentScreen === "question") {
        app.innerHTML = `
          <div class="flex flex-col items-center justify-center h-full px-4 py-10">
            <div class="rounded-lg shadow-xl p-8 max-w-3xl w-full" style="background:${surfaceColor};">
              <div class="mb-6 flex justify-between items-center">
                <span style="font-size:${baseSize*1.1}px;">å¾—åˆ†: ${score}</span>
                <span style="font-size:${baseSize*1.1}px;">ç¬¬ ${questionsAnswered + 1} é¡Œ</span>
              </div>

              <div class="mb-6 flex justify-center">
                <svg id="questionShape"
                     width="520" height="260" viewBox="0 0 360 180"
                     style="background:${bgColor};border-radius:16px;padding:12px;"></svg>
              </div>

              <h2 class="font-bold mb-6" style="font-size:${baseSize*1.4}px;">
                ${currentQuestion.text}
              </h2>

              <div class="space-y-3">
                ${currentQuestion.options.map((opt,i)=>`
                  <button class="option-btn w-full text-left px-6 py-4 rounded-lg font-semibold transition hover:opacity-80"
                    data-index="${i}" style="background:${primaryColor};color:#fff;font-size:${baseSize}px;">
                    ${opt}
                  </button>
                `).join("")}
              </div>
            </div>
          </div>
        `;

        drawShape("questionShape", currentQuestion.shape, currentQuestion.dimensions, primaryColor);

        document.querySelectorAll(".option-btn").forEach(btn=>{
          btn.onclick = ()=>checkAnswer(parseInt(btn.dataset.index,10));
        });
        return;
      }

      if (currentScreen === "runner") {
        app.innerHTML = `
          <div class="flex flex-col items-center justify-center h-full px-4 py-10">
            <div class="mb-4" style="font-size:${baseSize*1.2}px;">
              æ”¶é›†èŠ±æœµï¼å¾—åˆ†: ${score}
            </div>

            <div class="relative">
              <canvas id="gameCanvas" width="600" height="300" style="border-color:${primaryColor};"></canvas>
              <div class="mt-4">
                <label style="font-size:${baseSize}px;">æ§åˆ¶ä¸Šä¸‹ï¼š</label>
                <input type="range" id="slider" min="0" max="250" value="150"
                       style="width:300px;accent-color:${primaryColor};" class="ml-2">
              </div>
            </div>
          </div>
        `;
        startRunnerGame();
        return;
      }

      if (currentScreen === "records") {
        const records = loadRecords();
        app.innerHTML = `
          <div class="flex flex-col h-full px-4 py-8">
            <div class="max-w-2xl w-full mx-auto">
              <h2 class="font-bold mb-6 text-center" style="font-size:${baseSize*2}px;">éŠæˆ²ç´€éŒ„</h2>

              <div class="rounded-lg shadow-xl p-6 mb-6" style="background:${surfaceColor};">
                ${records.length===0 ? `
                  <p class="text-center" style="font-size:${baseSize}px;">é‚„æ²’æœ‰ç´€éŒ„ï¼Œå¿«å»ç©éŠæˆ²å§ï¼</p>
                ` : `
                  <div class="space-y-3">
                    ${records.map((r,idx)=>`
                      <div class="p-4 rounded-lg border-2" style="background:${config.background_color};border-color:${primaryColor};">
                        <div class="flex justify-between items-center">
                          <span class="font-bold" style="font-size:${baseSize}px;">ç¬¬ ${idx+1} å</span>
                          <span class="font-bold" style="font-size:${baseSize*1.2}px;color:${primaryColor};">${r.score} åˆ†</span>
                        </div>
                        <div class="mt-2 opacity-75" style="font-size:${baseSize*0.85}px;">
                          ç­”å° ${r.questionsAnswered} é¡Œ | ${new Date(r.timestamp).toLocaleString('zh-TW')}
                        </div>
                      </div>
                    `).join("")}
                  </div>
                `}
              </div>

              <div class="grid grid-cols-2 gap-3">
                <button id="backBtn" class="px-6 py-3 rounded-lg font-bold shadow-lg hover:opacity-90 transition"
                  style="background:${secondaryColor};color:#fff;font-size:${baseSize}px;">è¿”å›ä¸»ç•«é¢</button>

                <button id="clearBtn" class="px-6 py-3 rounded-lg font-bold shadow-lg hover:opacity-90 transition"
                  style="background:${primaryColor};color:#fff;font-size:${baseSize}px;">æ¸…ç©ºç´€éŒ„</button>
              </div>
            </div>
          </div>
        `;
        document.getElementById("backBtn").onclick = ()=>{ currentScreen="home"; render(); };
        document.getElementById("clearBtn").onclick = ()=>{
          localStorage.removeItem(STORAGE_KEY);
          render();
        };
        return;
      }
    }

    function startGame(){
      score = 0;
      questionsAnswered = 0;
      currentScreen = "question";
      loadQuestion();
    }

    function loadQuestion(){
      currentQuestion = generateQuestion(); // âœ… æ¯æ¬¡éƒ½é‡æ–°éš¨æ©Ÿå‡ºé¡Œ
      render();
    }

    // =====================
    // âœ… SVG ç¹ªåœ–ï¼šåœ–ä¸Šå¯«ã€Œåº•=ã€ã€Œé«˜=ã€
    // =====================
    function svgEl(tag){ return document.createElementNS("http://www.w3.org/2000/svg", tag); }

    function drawRightAngle(svg, x, y, size=10){
      const p = svgEl("path");
      p.setAttribute("d", `M ${x} ${y} l ${size} 0 l 0 ${size} l ${-size} 0 Z`);
      p.setAttribute("fill","none");
      p.setAttribute("stroke","#000");
      p.setAttribute("stroke-width","2");
      svg.appendChild(p);
    }

    function drawLabel(svg, x, y, text, size=22){
      const t = svgEl("text");
      t.setAttribute("x", x);
      t.setAttribute("y", y);
      t.setAttribute("fill","#000");
      t.setAttribute("font-size", size);
      t.setAttribute("font-weight","800");
      t.setAttribute("text-anchor","middle");
      t.textContent = text;
      svg.appendChild(t);
    }

    function drawShape(svgId, shape, dim, color){
      const svg = document.getElementById(svgId);
      if(!svg) return;
      svg.innerHTML = "";

      const fillGreen = color + "33";
      const fillBeige = "#f5d9b3";
      const fillBlue  = "#cfe9f7";

      // å¹³è¡Œå››é‚Šå½¢(ç‰ˆæœ¬1)
      if(shape==="paraA"){
        const s = 9;
        const basePx = dim.base * s;
        const heightPx = dim.height * s;
        const slant = 40;

        const path = `M 70 ${135-heightPx} L ${70+slant+basePx} ${135-heightPx} L ${70+basePx} 135 L ${70-slant} 135 Z`;
        const poly = svgEl("path");
        poly.setAttribute("d", path);
        poly.setAttribute("fill", fillGreen);
        poly.setAttribute("stroke","#000");
        poly.setAttribute("stroke-width","3");
        svg.appendChild(poly);

        const hx = 70 + basePx/2;
        const hLine = svgEl("line");
        hLine.setAttribute("x1",hx); hLine.setAttribute("y1",135-heightPx);
        hLine.setAttribute("x2",hx); hLine.setAttribute("y2",135);
        hLine.setAttribute("stroke","#000");
        hLine.setAttribute("stroke-width","3");
        hLine.setAttribute("stroke-dasharray","6,6");
        svg.appendChild(hLine);

        drawRightAngle(svg, hx-12, 135-heightPx+2, 12);
        drawRightAngle(svg, hx-12, 135-12, 12);

        drawLabel(svg, hx-80, 92, `é«˜ = ${dim.height}${dim.unit}`, 22);
        drawLabel(svg, 70+basePx/2, 173, `åº• = ${dim.base}${dim.unit}`, 22);
        return;
      }

      // å¹³è¡Œå››é‚Šå½¢(ç‰ˆæœ¬2ï¼šé•·æ–œæ¢)
      if(shape==="paraB"){
        const s = 6;
        const basePx = dim.base * s;
        const heightPx = dim.height * s;
        const x0 = 110, y0 = 135, length = 220;

        const path = `M ${x0} ${y0-heightPx} L ${x0+basePx} ${y0-heightPx} L ${x0+basePx+length} ${y0} L ${x0+length} ${y0} Z`;
        const poly = svgEl("path");
        poly.setAttribute("d", path);
        poly.setAttribute("fill", fillGreen);
        poly.setAttribute("stroke","#000");
        poly.setAttribute("stroke-width","3");
        svg.appendChild(poly);

        const xH = x0-55;
        const v = svgEl("line");
        v.setAttribute("x1",xH); v.setAttribute("y1",y0-heightPx);
        v.setAttribute("x2",xH); v.setAttribute("y2",y0);
        v.setAttribute("stroke","#000");
        v.setAttribute("stroke-width","3");
        v.setAttribute("stroke-dasharray","6,6");
        svg.appendChild(v);

        const h = svgEl("line");
        h.setAttribute("x1",xH); h.setAttribute("y1",y0);
        h.setAttribute("x2",x0+length); h.setAttribute("y2",y0);
        h.setAttribute("stroke","#000");
        h.setAttribute("stroke-width","3");
        h.setAttribute("stroke-dasharray","6,6");
        svg.appendChild(h);

        drawRightAngle(svg, xH, y0-12, 12);

        drawLabel(svg, xH-65, y0-heightPx/2+10, `é«˜ = ${dim.height}${dim.unit}`, 20);
        drawLabel(svg, x0+basePx+length-45, y0+35, `åº• = ${dim.base}${dim.unit}`, 20);
        return;
      }

      // ä¸‰è§’å½¢(ç‰ˆæœ¬1ï¼šé«˜å‚ç›´è½åˆ°åº•)
      if(shape==="triA"){
        const s = 10;
        const basePx = dim.base * s;
        const heightPx = dim.height * s;
        const A={x:60,y:140}, B={x:60+basePx,y:140}, C={x:60+basePx/2,y:140-heightPx};

        const tri = svgEl("path");
        tri.setAttribute("d", `M ${A.x} ${A.y} L ${C.x} ${C.y} L ${B.x} ${B.y} Z`);
        tri.setAttribute("fill", fillBeige);
        tri.setAttribute("stroke","#000");
        tri.setAttribute("stroke-width","3");
        svg.appendChild(tri);

        const alt = svgEl("line");
        alt.setAttribute("x1",C.x); alt.setAttribute("y1",C.y);
        alt.setAttribute("x2",C.x); alt.setAttribute("y2",A.y);
        alt.setAttribute("stroke","#000");
        alt.setAttribute("stroke-width","3");
        alt.setAttribute("stroke-dasharray","6,6");
        svg.appendChild(alt);

        drawRightAngle(svg, C.x-12, A.y-12, 12);

        drawLabel(svg, C.x-90, (C.y+A.y)/2+10, `é«˜ = ${dim.height}${dim.unit}`, 20);
        drawLabel(svg, (A.x+B.x)/2, A.y+35, `åº• = ${dim.base}${dim.unit}`, 22);
        return;
      }

      // ä¸‰è§’å½¢(ç‰ˆæœ¬2ï¼šé«˜è½åœ¨æ–œé‚Šä¸Šï¼Œåƒç¯„ä¾‹)
      if(shape==="triB"){
        const A={x:80,y:150}, B={x:220,y:150}, C={x:120,y:30};

        const tri = svgEl("path");
        tri.setAttribute("d", `M ${A.x} ${A.y} L ${C.x} ${C.y} L ${B.x} ${B.y} Z`);
        tri.setAttribute("fill", fillGreen);
        tri.setAttribute("stroke","#000");
        tri.setAttribute("stroke-width","3");
        svg.appendChild(tri);

        // è®“ã€Œåº•ã€è¦–è¦ºä¸Šå°æ‡‰ ABï¼Œä½†åº•é•·åº¦ç”¨ dim.baseï¼ˆåªåšæ¨™ç¤ºï¼‰
        drawLabel(svg, (A.x+B.x)/2, A.y+35, `åº• = ${dim.base}${dim.unit}`, 22);

        // ä½œä¸€æ¢è™›ç·šé«˜ï¼šå¾ A æ‹‰åˆ° CB çš„å‚è¶³
        const vx=B.x-C.x, vy=B.y-C.y;
        const wx=A.x-C.x, wy=A.y-C.y;
        const t=(wx*vx+wy*vy)/(vx*vx+vy*vy);
        const P={x:C.x+t*vx, y:C.y+t*vy};

        const alt = svgEl("line");
        alt.setAttribute("x1",A.x); alt.setAttribute("y1",A.y);
        alt.setAttribute("x2",P.x); alt.setAttribute("y2",P.y);
        alt.setAttribute("stroke","#000");
        alt.setAttribute("stroke-width","3");
        alt.setAttribute("stroke-dasharray","6,6");
        svg.appendChild(alt);

        drawRightAngle(svg, P.x-10, P.y-10, 10);

        const midAP={x:(A.x+P.x)/2,y:(A.y+P.y)/2};
        drawLabel(svg, midAP.x-80, midAP.y+10, `é«˜ = ${dim.height}${dim.unit}`, 20);

        // æ–œé‚Šè£é£¾æ•¸å­—ï¼ˆä¸å½±éŸ¿ç­”æ¡ˆï¼‰
        const midCB={x:(C.x+B.x)/2,y:(C.y+B.y)/2};
        drawLabel(svg, midCB.x+95, midCB.y+10, `${dim.side}${dim.unit}`, 20);
        return;
      }

      // ç›´è§’ä¸‰è§’å½¢
      if(shape==="rightTri"){
        const s = 8;
        const O={x:90,y:150};
        const P={x:O.x+dim.b*s,y:O.y};
        const Q={x:O.x,y:O.y-dim.a*s};

        const tri = svgEl("path");
        tri.setAttribute("d", `M ${Q.x} ${Q.y} L ${O.x} ${O.y} L ${P.x} ${P.y} Z`);
        tri.setAttribute("fill", fillBlue);
        tri.setAttribute("stroke","#000");
        tri.setAttribute("stroke-width","3");
        svg.appendChild(tri);

        drawRightAngle(svg, O.x, O.y-12, 12);

        drawLabel(svg, O.x-95, (O.y+Q.y)/2+10, `é«˜ = ${dim.a}${dim.unit}`, 18);
        drawLabel(svg, (O.x+P.x)/2, O.y+35, `åº• = ${dim.b}${dim.unit}`, 20);

        // æ–œé‚Šé¡¯ç¤º cï¼ˆè£é£¾ï¼‰
        const midQP={x:(Q.x+P.x)/2,y:(Q.y+P.y)/2};
        drawLabel(svg, midQP.x+80, midQP.y-5, `${dim.c}${dim.unit}`, 18);
        return;
      }
    }

    // =====================
    // âœ… éŠæˆ²æµç¨‹
    // =====================
    function checkAnswer(selectedIndex){
      if(selectedIndex===currentQuestion.correct){
        score += 10;
        questionsAnswered += 1;
        currentScreen = "runner";
        render();
      } else {
        endGame();
      }
    }

    function startRunnerGame(){
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const slider = document.getElementById("slider");

      runnerY = 150;
      flowers = [];
      let gameTime = 0;
      const gameDuration = 5000;

      slider.oninput = (e)=> runnerY = parseInt(e.target.value,10);

      function spawnFlower(){
        flowers.push({ x: canvas.width, y: Math.random()*(canvas.height-30), collected:false });
      }
      spawnFlower();

      gameInterval = setInterval(()=>{
        gameTime += 50;
        ctx.clearRect(0,0,canvas.width,canvas.height);

        ctx.fillStyle = config.text_color;
        ctx.font = "30px Arial";
        ctx.fillText("ğŸƒ", runnerX, runnerY);

        flowers = flowers.filter(f=>{
          f.x -= 5;
          if(Math.abs(f.x-runnerX)<30 && Math.abs(f.y-runnerY)<30){
            score += 5;
            return false;
          }
          if(f.x > -30){
            ctx.fillText("ğŸŒ¸", f.x, f.y);
            return true;
          }
          return false;
        });

        if(Math.random()<0.03) spawnFlower();

        if(gameTime >= gameDuration){
          clearInterval(gameInterval);
          currentScreen="question";
          loadQuestion(); // âœ… ä¸‹ä¸€é¡Œå†éš¨æ©Ÿ
        }
      }, 50);
    }

    function endGame(){
      if(gameInterval) clearInterval(gameInterval);

      const record = {
        id: Date.now().toString(),
        score,
        timestamp: Date.now(),
        questionsAnswered
      };
      saveRecord(record);
      currentScreen = "records";
      render();
    }

    function showRecords(){
      currentScreen="records";
      render();
    }

    // start
    currentScreen="home";
    render();
  </script>
</body>
</html>
