<!doctype html>
<html lang="zh-TW" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç¨®èŠ±é«˜æ‰‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; }
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
    .flower-icon{ animation: float 3s ease-in-out infinite; }
    #gameCanvas{ border: 3px solid; }
  </style>
</head>

<body class="h-full overflow-auto">
  <div id="app" class="w-full h-full"></div>

  <script>
    // =====================
    // âœ… ä¸ç”¨ SDKï¼šæ”¹ç”¨ localStorage
    // =====================
    const STORAGE_KEY = "flower_game_records_v1";
    function loadRecords() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
      catch { return []; }
    }
    function saveRecord(record) {
      const records = loadRecords();
      records.push(record);
      // åªä¿ç•™å‰ 999 ç­†ï¼ˆæ–°åˆ°èˆŠï¼‰
      records.sort((a,b)=>b.timestamp-a.timestamp);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(records.slice(0, 999)));
      return records.slice(0, 999);
    }

    // =====================
    // âœ… è¨­å®š
    // =====================
    const config = {
      background_color: "#FFF8DC",
      surface_color: "#FFFFFF",
      text_color: "#2C5530",
      primary_action_color: "#4CAF50",
      secondary_action_color: "#FF9800",
      font_family: "sans-serif",
      font_size: 16,
      game_title: "ğŸŒ¸ ç¨®èŠ±é«˜æ‰‹ ğŸŒ¸",
      start_button_text: "é–‹å§‹éŠæˆ²",
      records_button_text: "éŠæˆ²ç´€éŒ„"
    };

    let currentScreen = "home";
    let currentQuestion = null;
    let score = 0;
    let questionsAnswered = 0;

    let gameInterval = null;
    let runnerY = 150;
    let runnerX = 50;
    let flowers = [];

    // âœ… äº”å¼µç¯„ä¾‹é¡Œå‹ï¼ˆé¡Œç›®+é¸é …+åœ–ï¼‰
    const questions = [
      {
        text: "å¹³è¡Œå››é‚Šå½¢ï¼ˆå¦‚åœ–ï¼‰ï¼šåº• 14 cmï¼Œé«˜ 10 cmï¼Œé¢ç©æ˜¯å¤šå°‘ï¼Ÿ",
        options: ["140 cmÂ²", "70 cmÂ²", "240 cmÂ²", "14 cmÂ²"],
        correct: 0,
        shape: "paraA",
        dimensions: { base: 14, height: 10, unit: "cm" }
      },
      {
        text: "å¹³è¡Œå››é‚Šå½¢ï¼ˆå¦‚åœ–ï¼‰ï¼šåº• 10 mï¼Œé«˜ 25 mï¼Œé¢ç©æ˜¯å¤šå°‘ï¼Ÿ",
        options: ["250 mÂ²", "175 mÂ²", "125 mÂ²", "350 mÂ²"],
        correct: 0,
        shape: "paraB",
        dimensions: { base: 10, height: 25, unit: "m" }
      },
      {
        text: "ä¸‰è§’å½¢ï¼ˆå¦‚åœ–ï¼‰ï¼šåº• 16 cmï¼Œé«˜ 9 cmï¼Œé¢ç©æ˜¯å¤šå°‘ï¼Ÿ",
        options: ["72 cmÂ²", "144 cmÂ²", "25 cmÂ²", "80 cmÂ²"],
        correct: 0,
        shape: "triA",
        dimensions: { base: 16, height: 9, unit: "cm" }
      },
      {
        text: "ä¸‰è§’å½¢ï¼ˆå¦‚åœ–ï¼‰ï¼šåº• 6 cmï¼Œåœ–ä¸­è™›ç·šé«˜ç‚º 5 cmï¼Œé¢ç©æ˜¯å¤šå°‘ï¼Ÿ",
        options: ["15 cmÂ²", "30 cmÂ²", "11 cmÂ²", "24 cmÂ²"],
        correct: 0,
        shape: "triB",
        dimensions: { base: 6, height: 5, side: 8, unit: "cm" }
      },
      {
        text: "ç›´è§’ä¸‰è§’å½¢ï¼ˆå¦‚åœ–ï¼‰ï¼šå…©ç›´è§’é‚Šç‚º 12 cmã€5 cmï¼Œé¢ç©æ˜¯å¤šå°‘ï¼Ÿ",
        options: ["30 cmÂ²", "60 cmÂ²", "78 cmÂ²", "17 cmÂ²"],
        correct: 0,
        shape: "rightTri",
        dimensions: { a: 12, b: 5, c: 13, unit: "cm" }
      }
    ];

    // =====================
    // âœ… UI render
    // =====================
    function render() {
      const app = document.getElementById("app");
      const baseSize = config.font_size;
      const bgColor = config.background_color;
      const surfaceColor = config.surface_color;
      const textColor = config.text_color;
      const primaryColor = config.primary_action_color;
      const secondaryColor = config.secondary_action_color;

      app.style.backgroundColor = bgColor;
      app.style.fontFamily = `${config.font_family}, Arial, sans-serif`;
      app.style.color = textColor;

      if (currentScreen === "home") {
        app.innerHTML = `
          <div class="flex flex-col items-center justify-center h-full px-4 py-10">
            <h1 class="font-bold mb-8 text-center" style="font-size:${baseSize*2.5}px;color:${textColor};">
              ${config.game_title}
            </h1>
            <div class="flower-icon mb-12 text-8xl">ğŸŒºğŸŒ»ğŸŒ·</div>

            <button id="startBtn"
              class="px-8 py-4 rounded-lg font-bold shadow-lg hover:opacity-90 transition mb-4"
              style="background:${primaryColor};color:#fff;font-size:${baseSize*1.2}px;">
              ${config.start_button_text}
            </button>

            <button id="recordsBtn"
              class="px-6 py-3 rounded-lg font-bold shadow-lg hover:opacity-90 transition"
              style="background:${secondaryColor};color:#fff;font-size:${baseSize}px;">
              ${config.records_button_text}
            </button>
          </div>
        `;
        document.getElementById("startBtn").onclick = startGame;
        document.getElementById("recordsBtn").onclick = showRecords;
        return;
      }

      if (currentScreen === "question") {
        app.innerHTML = `
          <div class="flex flex-col items-center justify-center h-full px-4 py-10">
            <div class="rounded-lg shadow-xl p-8 max-w-2xl w-full" style="background:${surfaceColor};">
              <div class="mb-6 flex justify-between items-center">
                <span style="font-size:${baseSize*1.1}px;">å¾—åˆ†: ${score}</span>
                <span style="font-size:${baseSize*1.1}px;">ç¬¬ ${questionsAnswered + 1} é¡Œ</span>
              </div>

              <div class="mb-6 flex justify-center">
                <svg id="questionShape" width="360" height="180"
                     style="background:${bgColor};border-radius:12px;padding:10px;"></svg>
              </div>

              <h2 class="font-bold mb-6" style="font-size:${baseSize*1.4}px;">
                ${currentQuestion.text}
              </h2>

              <div class="space-y-3">
                ${currentQuestion.options.map((opt,i)=>`
                  <button class="option-btn w-full text-left px-6 py-4 rounded-lg font-semibold transition hover:opacity-80"
                    data-index="${i}" style="background:${primaryColor};color:#fff;font-size:${baseSize}px;">
                    ${opt}
                  </button>
                `).join("")}
              </div>
            </div>
          </div>
        `;

        drawShape("questionShape", currentQuestion.shape, currentQuestion.dimensions, primaryColor);

        document.querySelectorAll(".option-btn").forEach(btn=>{
          btn.onclick = ()=>checkAnswer(parseInt(btn.dataset.index,10));
        });
        return;
      }

      if (currentScreen === "runner") {
        app.innerHTML = `
          <div class="flex flex-col items-center justify-center h-full px-4 py-10">
            <div class="mb-4" style="font-size:${baseSize*1.2}px;">
              æ”¶é›†èŠ±æœµï¼å¾—åˆ†: ${score}
            </div>

            <div class="relative">
              <canvas id="gameCanvas" width="600" height="300" style="border-color:${primaryColor};"></canvas>
              <div class="mt-4">
                <label style="font-size:${baseSize}px;">æ§åˆ¶ä¸Šä¸‹ï¼š</label>
                <input type="range" id="slider" min="0" max="250" value="150"
                       style="width:300px;accent-color:${primaryColor};" class="ml-2">
              </div>
            </div>
          </div>
        `;
        startRunnerGame();
        return;
      }

      if (currentScreen === "records") {
        const records = loadRecords();
        app.innerHTML = `
          <div class="flex flex-col h-full px-4 py-8">
            <div class="max-w-2xl w-full mx-auto">
              <h2 class="font-bold mb-6 text-center" style="font-size:${baseSize*2}px;">éŠæˆ²ç´€éŒ„</h2>

              <div class="rounded-lg shadow-xl p-6 mb-6" style="background:${surfaceColor};">
                ${records.length===0 ? `
                  <p class="text-center" style="font-size:${baseSize}px;">é‚„æ²’æœ‰ç´€éŒ„ï¼Œå¿«å»ç©éŠæˆ²å§ï¼</p>
                ` : `
                  <div class="space-y-3">
                    ${records.map((r,idx)=>`
                      <div class="p-4 rounded-lg border-2" style="background:${bgColor};border-color:${primaryColor};">
                        <div class="flex justify-between items-center">
                          <span class="font-bold" style="font-size:${baseSize}px;">ç¬¬ ${idx+1} å</span>
                          <span class="font-bold" style="font-size:${baseSize*1.2}px;color:${primaryColor};">${r.score} åˆ†</span>
                        </div>
                        <div class="mt-2 opacity-75" style="font-size:${baseSize*0.85}px;">
                          ç­”å° ${r.questionsAnswered} é¡Œ | ${new Date(r.timestamp).toLocaleString('zh-TW')}
                        </div>
                      </div>
                    `).join("")}
                  </div>
                `}
              </div>

              <div class="grid grid-cols-2 gap-3">
                <button id="backBtn" class="px-6 py-3 rounded-lg font-bold shadow-lg hover:opacity-90 transition"
                  style="background:${secondaryColor};color:#fff;font-size:${baseSize}px;">è¿”å›ä¸»ç•«é¢</button>

                <button id="clearBtn" class="px-6 py-3 rounded-lg font-bold shadow-lg hover:opacity-90 transition"
                  style="background:${primaryColor};color:#fff;font-size:${baseSize}px;">æ¸…ç©ºç´€éŒ„</button>
              </div>
            </div>
          </div>
        `;
        document.getElementById("backBtn").onclick = ()=>{ currentScreen="home"; render(); };
        document.getElementById("clearBtn").onclick = ()=>{
          localStorage.removeItem(STORAGE_KEY);
          render();
        };
        return;
      }
    }

    function startGame(){
      score = 0;
      questionsAnswered = 0;
      currentScreen = "question";
      loadQuestion();
    }

    function loadQuestion(){
      currentQuestion = questions[Math.floor(Math.random()*questions.length)];
      render();
    }

    // =====================
    // âœ… åœ–å½¢ SVGï¼šç…§ä½ äº”å¼µç¯„ä¾‹é¢¨æ ¼
    // =====================
    function svgEl(tag){ return document.createElementNS("http://www.w3.org/2000/svg", tag); }

    function addArrowMarkers(svg){
      if (svg.querySelector("#arrowStart")) return;
      const defs = svgEl("defs");

      const mk = (id, d)=>{
        const m = svgEl("marker");
        m.setAttribute("id", id);
        m.setAttribute("markerWidth","10");
        m.setAttribute("markerHeight","10");
        m.setAttribute("refX","5");
        m.setAttribute("refY","5");
        m.setAttribute("orient","auto");
        const p = svgEl("path");
        p.setAttribute("d", d);
        p.setAttribute("stroke","#000");
        p.setAttribute("stroke-width","2");
        p.setAttribute("fill","none");
        m.appendChild(p);
        return m;
      };

      defs.appendChild(mk("arrowStart","M 8 2 L 2 5 L 8 8"));
      defs.appendChild(mk("arrowEnd","M 2 2 L 8 5 L 2 8"));
      svg.appendChild(defs);
    }

    function drawRightAngle(svg, x, y, size=10){
      const p = svgEl("path");
      p.setAttribute("d", `M ${x} ${y} l ${size} 0 l 0 ${size} l ${-size} 0 Z`);
      p.setAttribute("fill","none");
      p.setAttribute("stroke","#000");
      p.setAttribute("stroke-width","2");
      svg.appendChild(p);
    }

    function drawLabel(svg, x, y, text, size=30){
      const t = svgEl("text");
      t.setAttribute("x", x);
      t.setAttribute("y", y);
      t.setAttribute("fill","#000");
      t.setAttribute("font-size", size);
      t.setAttribute("font-weight","700");
      t.setAttribute("text-anchor","middle");
      t.textContent = text;
      svg.appendChild(t);
    }

    function drawShape(svgId, shape, dim, color){
      const svg = document.getElementById(svgId);
      if(!svg) return;
      svg.innerHTML = "";
      addArrowMarkers(svg);

      const fillGreen = color + "33";
      const fillBeige = "#f5d9b3";
      const fillBlue  = "#cfe9f7";

      if(shape==="paraA"){
        const s=10, basePx=dim.base*s, heightPx=dim.height*s, slant=40;
        const path = `M 60 ${130-heightPx} L ${60+slant+basePx} ${130-heightPx} L ${60+basePx} 130 L ${60-slant} 130 Z`;
        const poly = svgEl("path");
        poly.setAttribute("d", path);
        poly.setAttribute("fill", fillGreen);
        poly.setAttribute("stroke","#000");
        poly.setAttribute("stroke-width","3");
        svg.appendChild(poly);

        const hx = 60 + basePx/2;
        const hLine = svgEl("line");
        hLine.setAttribute("x1",hx); hLine.setAttribute("y1",130-heightPx);
        hLine.setAttribute("x2",hx); hLine.setAttribute("y2",130);
        hLine.setAttribute("stroke","#000");
        hLine.setAttribute("stroke-width","3");
        hLine.setAttribute("stroke-dasharray","6,6");
        svg.appendChild(hLine);

        drawRightAngle(svg, hx-12, 130-heightPx+2, 12);
        drawRightAngle(svg, hx-12, 130-12, 12);

        drawLabel(svg, hx-55, 85, `${dim.height}${dim.unit}`, 30);
        drawLabel(svg, 60+basePx/2, 170, `${dim.base}${dim.unit}`, 34);
        return;
      }

      if(shape==="paraB"){
        const s=6, basePx=dim.base*s, heightPx=dim.height*s;
        const x0=120, y0=135, length=220;
        const path = `M ${x0} ${y0-heightPx} L ${x0+basePx} ${y0-heightPx} L ${x0+basePx+length} ${y0} L ${x0+length} ${y0} Z`;
        const poly = svgEl("path");
        poly.setAttribute("d", path);
        poly.setAttribute("fill", fillGreen);
        poly.setAttribute("stroke","#000");
        poly.setAttribute("stroke-width","3");
        svg.appendChild(poly);

        const xH = x0-50;
        const v = svgEl("line");
        v.setAttribute("x1",xH); v.setAttribute("y1",y0-heightPx);
        v.setAttribute("x2",xH); v.setAttribute("y2",y0);
        v.setAttribute("stroke","#000");
        v.setAttribute("stroke-width","3");
        v.setAttribute("stroke-dasharray","6,6");
        svg.appendChild(v);

        const h = svgEl("line");
        h.setAttribute("x1",xH); h.setAttribute("y1",y0);
        h.setAttribute("x2",x0+length); h.setAttribute("y2",y0);
        h.setAttribute("stroke","#000");
        h.setAttribute("stroke-width","3");
        h.setAttribute("stroke-dasharray","6,6");
        svg.appendChild(h);

        drawRightAngle(svg, xH, y0-12, 12);

        drawLabel(svg, xH-35, y0-heightPx/2+10, `${dim.height}${dim.unit}`, 32);
        drawLabel(svg, x0+basePx+length-15, y0+35, `${dim.base}${dim.unit}`, 32);
        return;
      }

      if(shape==="triA"){
        const s=12, basePx=dim.base*s, heightPx=dim.height*s;
        const A={x:60,y:140}, B={x:60+basePx,y:140}, C={x:60+basePx/2,y:140-heightPx};

        const tri = svgEl("path");
        tri.setAttribute("d", `M ${A.x} ${A.y} L ${C.x} ${C.y} L ${B.x} ${B.y} Z`);
        tri.setAttribute("fill", fillBeige);
        tri.setAttribute("stroke","#000");
        tri.setAttribute("stroke-width","3");
        svg.appendChild(tri);

        const alt = svgEl("line");
        alt.setAttribute("x1",C.x); alt.setAttribute("y1",C.y);
        alt.setAttribute("x2",C.x); alt.setAttribute("y2",A.y);
        alt.setAttribute("stroke","#000");
        alt.setAttribute("stroke-width","3");
        alt.setAttribute("stroke-dasharray","6,6");
        svg.appendChild(alt);

        drawRightAngle(svg, C.x-12, A.y-12, 12);

        drawLabel(svg, C.x-55, (C.y+A.y)/2+10, `${dim.height}${dim.unit}`, 32);
        drawLabel(svg, (A.x+B.x)/2, A.y+35, `${dim.base}${dim.unit}`, 34);
        return;
      }

      if(shape==="triB"){
        const A={x:80,y:150}, B={x:220,y:150}, C={x:120,y:30};

        const tri = svgEl("path");
        tri.setAttribute("d", `M ${A.x} ${A.y} L ${C.x} ${C.y} L ${B.x} ${B.y} Z`);
        tri.setAttribute("fill", fillGreen);
        tri.setAttribute("stroke","#000");
        tri.setAttribute("stroke-width","3");
        svg.appendChild(tri);

        // å‚è¶³
        const vx=B.x-C.x, vy=B.y-C.y;
        const wx=A.x-C.x, wy=A.y-C.y;
        const t=(wx*vx+wy*vy)/(vx*vx+vy*vy);
        const P={x:C.x+t*vx, y:C.y+t*vy};

        const alt = svgEl("line");
        alt.setAttribute("x1",A.x); alt.setAttribute("y1",A.y);
        alt.setAttribute("x2",P.x); alt.setAttribute("y2",P.y);
        alt.setAttribute("stroke","#000");
        alt.setAttribute("stroke-width","3");
        alt.setAttribute("stroke-dasharray","6,6");
        svg.appendChild(alt);

        drawRightAngle(svg, P.x-10, P.y-10, 10);

        drawLabel(svg, (A.x+B.x)/2, A.y+35, `${dim.base}${dim.unit}`, 34);

        const midCB={x:(C.x+B.x)/2,y:(C.y+B.y)/2};
        drawLabel(svg, midCB.x+55, midCB.y+10, `${dim.side}${dim.unit}`, 32);

        const midAP={x:(A.x+P.x)/2,y:(A.y+P.y)/2};
        drawLabel(svg, midAP.x-45, midAP.y+10, `${dim.height}${dim.unit}`, 32);
        return;
      }

      if(shape==="rightTri"){
        const s=10;
        const O={x:90,y:150};
        const P={x:O.x+dim.b*s,y:O.y};
        const Q={x:O.x,y:O.y-dim.a*s};

        const tri = svgEl("path");
        tri.setAttribute("d", `M ${Q.x} ${Q.y} L ${O.x} ${O.y} L ${P.x} ${P.y} Z`);
        tri.setAttribute("fill", fillBlue);
        tri.setAttribute("stroke","#000");
        tri.setAttribute("stroke-width","3");
        svg.appendChild(tri);

        drawRightAngle(svg, O.x, O.y-12, 12);

        drawLabel(svg, O.x-55, (O.y+Q.y)/2+10, `${dim.a}${dim.unit}`, 32);
        drawLabel(svg, (O.x+P.x)/2, O.y+35, `${dim.b}${dim.unit}`, 32);

        const midQP={x:(Q.x+P.x)/2,y:(Q.y+P.y)/2};
        drawLabel(svg, midQP.x+40, midQP.y-5, `${dim.c}${dim.unit}`, 32);
        return;
      }
    }

    // =====================
    // âœ… éŠæˆ²æµç¨‹
    // =====================
    function checkAnswer(selectedIndex){
      if(selectedIndex===currentQuestion.correct){
        score += 10;
        questionsAnswered += 1;
        currentScreen = "runner";
        render();
      } else {
        endGame();
      }
    }

    function startRunnerGame(){
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const slider = document.getElementById("slider");

      runnerY = 150;
      flowers = [];
      let gameTime = 0;
      const gameDuration = 5000;

      slider.oninput = (e)=> runnerY = parseInt(e.target.value,10);

      function spawnFlower(){
        flowers.push({ x: canvas.width, y: Math.random()*(canvas.height-30), collected:false });
      }
      spawnFlower();

      gameInterval = setInterval(()=>{
        gameTime += 50;
        ctx.clearRect(0,0,canvas.width,canvas.height);

        ctx.fillStyle = config.text_color;
        ctx.font = "30px Arial";
        ctx.fillText("ğŸƒ", runnerX, runnerY);

        flowers = flowers.filter(f=>{
          f.x -= 5;

          if(Math.abs(f.x-runnerX)<30 && Math.abs(f.y-runnerY)<30){
            score += 5;
            return false;
          }
          if(f.x > -30){
            ctx.fillText("ğŸŒ¸", f.x, f.y);
            return true;
          }
          return false;
        });

        if(Math.random()<0.03) spawnFlower();

        if(gameTime >= gameDuration){
          clearInterval(gameInterval);
          currentScreen="question";
          loadQuestion();
        }
      }, 50);
    }

    function endGame(){
      if(gameInterval) clearInterval(gameInterval);

      const record = {
        id: Date.now().toString(),
        score,
        timestamp: Date.now(),
        questionsAnswered
      };
      saveRecord(record);
      currentScreen = "records";
      render();
    }

    function showRecords(){
      currentScreen="records";
      render();
    }

    // start
    currentScreen="home";
    render();
  </script>
</body>
</html>
