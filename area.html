<!doctype html>
<html lang="zh-TW" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç¨®èŠ±é«˜æ‰‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; }
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
    .flower-icon{ animation: float 3s ease-in-out infinite; }
    #gameCanvas{ border: 3px solid; }
  </style>
</head>

<body class="h-full overflow-auto">
  <div id="app" class="w-full h-full"></div>

<script>
/* =========================
   localStorage ç´€éŒ„
========================= */
const STORAGE_KEY = "flower_game_records_v4";
function loadRecords() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
  catch { return []; }
}
function saveRecord(record) {
  const records = loadRecords();
  records.push(record);
  records.sort((a,b)=>b.timestamp-a.timestamp);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(records.slice(0, 999)));
  return records.slice(0, 999);
}

/* =========================
   UI è¨­å®š
========================= */
const config = {
  background_color: "#FFF8DC",
  surface_color: "#FFFFFF",
  text_color: "#2C5530",
  primary_action_color: "#4CAF50",
  secondary_action_color: "#FF9800",
  font_family: "sans-serif",
  font_size: 16,
  game_title: "ğŸŒ¸ ç¨®èŠ±é«˜æ‰‹ ğŸŒ¸",
  start_button_text: "é–‹å§‹éŠæˆ²",
  records_button_text: "éŠæˆ²ç´€éŒ„"
};

let currentScreen = "home";
let currentQuestion = null;
let score = 0;
let questionsAnswered = 0;

let gameInterval = null;
let runnerY = 150;
let runnerX = 50;
let flowers = [];

/* =========================
   å·¥å…·ï¼šéš¨æ©Ÿ/æ ¼å¼
========================= */
function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
function shuffle(arr){
  const a = [...arr];
  for (let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function uniqueNumbers(arr){ return [...new Set(arr)]; }
function unitSq(unit){ return unit + "Â²"; }

/* =========================
   è‡ªå‹•ç”¢ç”Ÿé¸é …ï¼ˆ1æ­£ç¢º+3å¹²æ“¾ï¼‰
   æ¯å€‹é¸é …ã€Œä¸€è¡Œå¯«å®Œç®—å¼ã€
========================= */
function buildOptions({ type, base, height, unit, a, b }) {
  let correctValue = 0;
  let correctExpr = "";

  if (type === "parallelogram") {
    correctValue = base * height;
    correctExpr = `${base} Ã— ${height} = ${correctValue} ${unitSq(unit)}`;
  } else if (type === "triangle") {
    correctValue = (base * height) / 2;
    correctExpr = `${base} Ã— ${height} Ã· 2 = ${correctValue} ${unitSq(unit)}`;
  } else if (type === "rightTriangle") {
    correctValue = (a * b) / 2;
    correctExpr = `${a} Ã— ${b} Ã· 2 = ${correctValue} ${unitSq(unit)}`;
  }

  const wrongValues = [];
  if (type === "parallelogram") {
    wrongValues.push((base * height) / 2);
    wrongValues.push(base + height);
    wrongValues.push((base + height) * height);
  } else if (type === "triangle") {
    wrongValues.push(base * height);                 // å¿˜è¨˜ Ã·2
    wrongValues.push(base + height);
    wrongValues.push(((base + height) * height) / 2);
  } else if (type === "rightTriangle") {
    wrongValues.push(a * b);
    wrongValues.push(a + b);
    wrongValues.push(((a + b) * b) / 2);
  }

  wrongValues.push(correctValue + randInt(2, 12));
  wrongValues.push(Math.max(1, correctValue - randInt(2, 12)));

  const cleanedWrong = uniqueNumbers(
    wrongValues
      .map(v => Math.round(v*100)/100)
      .filter(v => v !== correctValue && v > 0)
  );

  const chosenWrong = cleanedWrong.slice(0, 3);
  while (chosenWrong.length < 3) {
    const v = correctValue + randInt(2, 20);
    if (v !== correctValue && !chosenWrong.includes(v)) chosenWrong.push(v);
  }

  const wrongExprs = chosenWrong.map((v, idx) => {
    if (type === "parallelogram") {
      const forms = [
        `${base} Ã— ${height} Ã· 2 = ${v} ${unitSq(unit)}`,
        `${base} + ${height} = ${v} ${unitSq(unit)}`,
        `(${base} + ${height}) Ã— ${height} = ${v} ${unitSq(unit)}`
      ];
      return forms[idx % forms.length];
    }
    if (type === "triangle") {
      const forms = [
        `${base} Ã— ${height} = ${v} ${unitSq(unit)}`,
        `${base} + ${height} = ${v} ${unitSq(unit)}`,
        `(${base} + ${height}) Ã— ${height} Ã· 2 = ${v} ${unitSq(unit)}`
      ];
      return forms[idx % forms.length];
    }
    // rightTriangle
    const forms = [
      `${a} Ã— ${b} = ${v} ${unitSq(unit)}`,
      `${a} + ${b} = ${v} ${unitSq(unit)}`,
      `(${a} + ${b}) Ã— ${b} Ã· 2 = ${v} ${unitSq(unit)}`
    ];
    return forms[idx % forms.length];
  });

  const all = shuffle([correctExpr, ...wrongExprs]);
  return { options: all, correctIndex: all.indexOf(correctExpr) };
}

/* =========================
   é¡Œå‹ï¼šç…§ä½ ç¯„ä¾‹çš„ä¸‰ç¨®åœ–
   1) triAï¼šåº•+é«˜ï¼ˆé«˜å‚ç›´åˆ°åº•ï¼‰
   2) triBï¼šåº•+é«˜è½åœ¨æ–œé‚Šä¸Šï¼ˆåƒ 6cm/5cm/8cmï¼‰
   3) rightTriï¼šç›´è§’ä¸‰è§’å½¢ï¼ˆåƒ 12/5/13ï¼‰
========================= */
function generateQuestion() {
  const pool = ["triA", "triB", "rightTri"];
  const shape = pool[randInt(0, pool.length - 1)];
  const unit = "cm";

  if (shape === "triA") {
    let base = randInt(10, 20);
    let height = randInt(6, 12);
    if ((base * height) % 2 !== 0) base += 1; // é¢ç©æ•´æ•¸
    const { options, correctIndex } = buildOptions({ type:"triangle", base, height, unit });
    return {
      shape,
      text: "ä¸‰è§’å½¢ï¼ˆå¦‚åœ–ï¼‰ï¼šæ±‚é¢ç©",
      dimensions: { base, height, unit },
      options,
      correct: correctIndex
    };
  }

  if (shape === "triB") {
    let base = randInt(6, 14);
    let height = randInt(4, 10);
    if ((base * height) % 2 !== 0) height += 1;
    const side = randInt(Math.max(base, height) + 1, Math.max(base, height) + 6); // è£é£¾ç”¨
    const { options, correctIndex } = buildOptions({ type:"triangle", base, height, unit });
    return {
      shape,
      text: "ä¸‰è§’å½¢ï¼ˆå¦‚åœ–ï¼‰ï¼šæ±‚é¢ç©",
      dimensions: { base, height, side, unit },
      options,
      correct: correctIndex
    };
  }

  // rightTri
  let a = randInt(8, 16);
  let b = randInt(4, 10);
  if ((a * b) % 2 !== 0) a += 1;

  // è®“ c æ¯”è¼ƒåƒç¯„ä¾‹ï¼šç”¨ sqrt å¾Œå–æ•´é¡¯ç¤ºï¼ˆè£é£¾ï¼‰
  const c = Math.round(Math.sqrt(a*a + b*b));
  const { options, correctIndex } = buildOptions({ type:"rightTriangle", a, b, unit });
  return {
    shape,
    text: "ç›´è§’ä¸‰è§’å½¢ï¼ˆå¦‚åœ–ï¼‰ï¼šæ±‚é¢ç©",
    dimensions: { a, b, c, unit },
    options,
    correct: correctIndex
  };
}

/* =========================
   Render
========================= */
function render() {
  const app = document.getElementById("app");
  const baseSize = config.font_size;
  const bgColor = config.background_color;
  const surfaceColor = config.surface_color;
  const textColor = config.text_color;
  const primaryColor = config.primary_action_color;
  const secondaryColor = config.secondary_action_color;

  app.style.backgroundColor = bgColor;
  app.style.fontFamily = `${config.font_family}, Arial, sans-serif`;
  app.style.color = textColor;

  if (currentScreen === "home") {
    app.innerHTML = `
      <div class="flex flex-col items-center justify-center h-full px-4 py-10">
        <h1 class="font-bold mb-8 text-center" style="font-size:${baseSize*2.5}px;color:${textColor};">
          ${config.game_title}
        </h1>
        <div class="flower-icon mb-12 text-8xl">ğŸŒºğŸŒ»ğŸŒ·</div>

        <button id="startBtn"
          class="px-8 py-4 rounded-lg font-bold shadow-lg hover:opacity-90 transition mb-4"
          style="background:${primaryColor};color:#fff;font-size:${baseSize*1.2}px;">
          ${config.start_button_text}
        </button>

        <button id="recordsBtn"
          class="px-6 py-3 rounded-lg font-bold shadow-lg hover:opacity-90 transition"
          style="background:${secondaryColor};color:#fff;font-size:${baseSize}px;">
          ${config.records_button_text}
        </button>
      </div>
    `;
    document.getElementById("startBtn").onclick = startGame;
    document.getElementById("recordsBtn").onclick = showRecords;
    return;
  }

  if (currentScreen === "question") {
    app.innerHTML = `
      <div class="flex flex-col items-center justify-center h-full px-4 py-10">
        <div class="rounded-lg shadow-xl p-8 max-w-3xl w-full" style="background:${surfaceColor};">
          <div class="mb-6 flex justify-between items-center">
            <span style="font-size:${baseSize*1.1}px;">å¾—åˆ†: ${score}</span>
            <span style="font-size:${baseSize*1.1}px;">ç¬¬ ${questionsAnswered + 1} é¡Œ</span>
          </div>

          <div class="mb-6 flex justify-center">
            <!-- æ›´åƒç¯„ä¾‹ï¼šæ¡†å¤§ã€ç•™ç™½å¤š -->
            <svg id="questionShape"
                 width="560" height="320" viewBox="0 0 360 220"
                 style="background:#fff;border-radius:14px;padding:10px;"></svg>
          </div>

          <h2 class="font-bold mb-6" style="font-size:${baseSize*1.4}px;">
            ${currentQuestion.text}
          </h2>

          <div class="space-y-3">
            ${currentQuestion.options.map((opt,i)=>`
              <button class="option-btn w-full text-left px-6 py-4 rounded-lg font-semibold transition hover:opacity-80"
                data-index="${i}" style="background:${primaryColor};color:#fff;font-size:${baseSize}px;">
                ${opt}
              </button>
            `).join("")}
          </div>
        </div>
      </div>
    `;

    drawShape("questionShape", currentQuestion.shape, currentQuestion.dimensions);
    document.querySelectorAll(".option-btn").forEach(btn=>{
      btn.onclick = ()=>checkAnswer(parseInt(btn.dataset.index,10));
    });
    return;
  }

  if (currentScreen === "runner") {
    app.innerHTML = `
      <div class="flex flex-col items-center justify-center h-full px-4 py-10">
        <div class="mb-4" style="font-size:${baseSize*1.2}px;">
          æ”¶é›†èŠ±æœµï¼å¾—åˆ†: ${score}
        </div>

        <div class="relative">
          <canvas id="gameCanvas" width="600" height="300" style="border-color:${primaryColor};"></canvas>
          <div class="mt-4">
            <label style="font-size:${baseSize}px;">æ§åˆ¶ä¸Šä¸‹ï¼š</label>
            <input type="range" id="slider" min="0" max="250" value="150"
                   style="width:300px;accent-color:${primaryColor};" class="ml-2">
          </div>
        </div>
      </div>
    `;
    startRunnerGame();
    return;
  }

  if (currentScreen === "records") {
    const records = loadRecords();
    app.innerHTML = `
      <div class="flex flex-col h-full px-4 py-8">
        <div class="max-w-2xl w-full mx-auto">
          <h2 class="font-bold mb-6 text-center" style="font-size:${baseSize*2}px;">éŠæˆ²ç´€éŒ„</h2>

          <div class="rounded-lg shadow-xl p-6 mb-6" style="background:${surfaceColor};">
            ${records.length===0 ? `
              <p class="text-center" style="font-size:${baseSize}px;">é‚„æ²’æœ‰ç´€éŒ„ï¼Œå¿«å»ç©éŠæˆ²å§ï¼</p>
            ` : `
              <div class="space-y-3">
                ${records.map((r,idx)=>`
                  <div class="p-4 rounded-lg border-2" style="background:${config.background_color};border-color:${primaryColor};">
                    <div class="flex justify-between items-center">
                      <span class="font-bold" style="font-size:${baseSize}px;">ç¬¬ ${idx+1} å</span>
                      <span class="font-bold" style="font-size:${baseSize*1.2}px;color:${primaryColor};">${r.score} åˆ†</span>
                    </div>
                    <div class="mt-2 opacity-75" style="font-size:${baseSize*0.85}px;">
                      ç­”å° ${r.questionsAnswered} é¡Œ | ${new Date(r.timestamp).toLocaleString('zh-TW')}
                    </div>
                  </div>
                `).join("")}
              </div>
            `}
          </div>

          <div class="grid grid-cols-2 gap-3">
            <button id="backBtn" class="px-6 py-3 rounded-lg font-bold shadow-lg hover:opacity-90 transition"
              style="background:${config.secondary_action_color};color:#fff;font-size:${baseSize}px;">è¿”å›ä¸»ç•«é¢</button>

            <button id="clearBtn" class="px-6 py-3 rounded-lg font-bold shadow-lg hover:opacity-90 transition"
              style="background:${config.primary_action_color};color:#fff;font-size:${baseSize}px;">æ¸…ç©ºç´€éŒ„</button>
          </div>
        </div>
      </div>
    `;
    document.getElementById("backBtn").onclick = ()=>{ currentScreen="home"; render(); };
    document.getElementById("clearBtn").onclick = ()=>{ localStorage.removeItem(STORAGE_KEY); render(); };
    return;
  }
}

function startGame(){
  score = 0;
  questionsAnswered = 0;
  currentScreen = "question";
  loadQuestion();
}
function loadQuestion(){
  currentQuestion = generateQuestion(); // âœ… æ¯æ¬¡éš¨æ©Ÿ
  render();
}

/* =========================
   SVG ç¹ªåœ–ï¼šåšæˆã€Œåƒç¯„ä¾‹çš„å¼§å½¢æ¨™ç¤ºã€
========================= */
function svgEl(tag){ return document.createElementNS("http://www.w3.org/2000/svg", tag); }
function setAttrs(el, attrs){
  for(const k in attrs) el.setAttribute(k, attrs[k]);
  return el;
}
function
